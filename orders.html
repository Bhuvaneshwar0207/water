<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - AquaStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Sticky Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-tint"></i> AquaStore
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="product_list.html">
                            <i class="fas fa-shopping-bag"></i> Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cart.html">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">
                            <i class="fas fa-box"></i> My Orders
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span id="navUserName">Account</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="profile.html">
                                <i class="fas fa-user-edit"></i> My Profile
                            </a></li>
                            <li><a class="dropdown-item" href="wishlist.html">
                                <i class="fas fa-heart"></i> Wishlist
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Orders Section -->
    <section class="py-5">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>My Orders</h2>
                <div class="d-flex gap-2">
                    <select class="form-select" id="orderFilter" onchange="filterOrders()">
                        <option value="all">All Orders</option>
                        <option value="placed">Placed</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="out-for-delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <button class="btn btn-outline-primary" onclick="loadOrders()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>

            <div id="ordersContainer">
                <!-- Orders will be loaded by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-tint"></i> AquaStore</h5>
                    <p>Your trusted partner for clean water delivery</p>
                </div>
                <div class="col-md-6 text-end">
                    <p>&copy; 2024 AquaStore. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadUserFromStorage();
            updateCartBadge();
            loadOrders();
            
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
        });

        function loadOrders() {
            const savedOrders = localStorage.getItem('aquaStoreOrders');
            if (savedOrders) {
                allOrders = JSON.parse(savedOrders);
            } else {
                // Mock orders for demonstration
                allOrders = [
                    {
                        orderId: 'ORD001',
                        orderDate: '2024-02-10',
                        totalAmount: 450,
                        status: 'delivered',
                        items: [
                            { name: '5L Water Can', quantity: 2, price: 95 },
                            { name: '2L Water Can', quantity: 5, price: 45 }
                        ],
                        deliveryAddress: {
                            name: 'Home Address',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001'
                        }
                    },
                    {
                        orderId: 'ORD002',
                        orderDate: '2024-02-11',
                        totalAmount: 800,
                        status: 'out-for-delivery',
                        items: [
                            { name: 'Residential 50L Bulk Package', quantity: 1, price: 800 }
                        ],
                        deliveryAddress: {
                            name: 'Office Address',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400002'
                        }
                    },
                    {
                        orderId: 'ORD003',
                        orderDate: '2024-02-12',
                        totalAmount: 180,
                        status: 'placed',
                        items: [
                            { name: '10L Water Can', quantity: 1, price: 180 }
                        ],
                        deliveryAddress: {
                            name: 'Home Address',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001'
                        }
                    }
                ];
            }
            
            filteredOrders = [...allOrders];
            filterOrders();
        }

        function filterOrders() {
            const statusFilter = document.getElementById('orderFilter').value;
            
            if (statusFilter === 'all') {
                filteredOrders = [...allOrders];
            } else {
                filteredOrders = allOrders.filter(order => order.status === statusFilter);
            }
            
            renderOrders();
        }

        function renderOrders() {
            const container = document.getElementById('ordersContainer');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h4>No orders found</h4>
                        <p class="text-muted">Start shopping to see your orders here!</p>
                        <a href="product_list.html" class="btn btn-primary mt-3">
                            <i class="fas fa-shopping-bag"></i> Start Shopping
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredOrders.map(order => `
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="mb-1">Order ID: ${order.orderId}</h6>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-calendar"></i> ${new Date(order.orderDate).toLocaleDateString()}
                                        </p>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-map-marker-alt"></i> ${order.deliveryAddress.name}, ${order.deliveryAddress.city}
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        ${getStatusBadge(order.status)}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6 class="mb-2">Order Items:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Quantity</th>
                                                    <th>Price</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${order.items.map(item => `
                                                    <tr>
                                                        <td>${item.name}</td>
                                                        <td>${item.quantity}</td>
                                                        <td>₹${item.price}</td>
                                                        <td>₹${item.price * item.quantity}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5>Total Amount:</h5>
                                        <h4 class="text-primary">₹${order.totalAmount}</h4>
                                    </div>
                                    <div class="d-flex gap-2">
                                        ${order.status === 'delivered' ? `
                                            <button class="btn btn-outline-primary" onclick="reorderItems('${order.orderId}')">
                                                <i class="fas fa-redo"></i> Reorder
                                            </button>
                                        ` : ''}
                                        ${order.status === 'placed' || order.status === 'confirmed' ? `
                                            <button class="btn btn-outline-danger" onclick="cancelOrder('${order.orderId}')">
                                                <i class="fas fa-times"></i> Cancel Order
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-outline-secondary" onclick="viewOrderDetails('${order.orderId}')">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">Delivery Address</h6>
                                        <p class="mb-2"><strong>${order.deliveryAddress.name}</strong></p>
                                        <p class="mb-2">${order.deliveryAddress.addressLine1 || 'N/A'}</p>
                                        ${order.deliveryAddress.addressLine2 ? `<p class="mb-2">${order.deliveryAddress.addressLine2}</p>` : ''}
                                        <p class="mb-2">${order.deliveryAddress.city}, ${order.deliveryAddress.state} - ${order.deliveryAddress.pincode}</p>
                                        <p class="mb-2"><strong>Phone:</strong> ${order.deliveryAddress.phone || 'N/A'}</p>
                                        
                                        <hr>
                                        
                                        <h6 class="mb-2">Order Timeline</h6>
                                        <div class="timeline">
                                            ${getTimelineHTML(order)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusBadge(status) {
            const statusConfig = {
                'placed': { class: 'bg-secondary', text: 'Placed', icon: 'clock' },
                'confirmed': { class: 'bg-info', text: 'Confirmed', icon: 'check-circle' },
                'out-for-delivery': { class: 'bg-warning', text: 'Out for Delivery', icon: 'truck' },
                'delivered': { class: 'bg-success', text: 'Delivered', icon: 'check-double' },
                'cancelled': { class: 'bg-danger', text: 'Cancelled', icon: 'times-circle' }
            };
            
            const config = statusConfig[status] || statusConfig['placed'];
            return `
                <span class="badge ${config.class}">
                    <i class="fas fa-${config.icon}"></i> ${config.text}
                </span>
            `;
        }

        function getTimelineHTML(order) {
            const orderDate = new Date(order.orderDate);
            const timeline = [
                { date: orderDate, status: 'Order Placed', icon: 'shopping-cart', completed: true },
                { date: new Date(orderDate.getTime() + 24 * 60 * 60 * 1000), status: 'Order Confirmed', icon: 'check-circle', completed: order.status !== 'placed' },
                { date: new Date(orderDate.getTime() + 48 * 60 * 60 * 1000), status: 'Out for Delivery', icon: 'truck', completed: ['out-for-delivery', 'delivered'].includes(order.status) },
                { date: new Date(orderDate.getTime() + 72 * 60 * 60 * 1000), status: 'Delivered', icon: 'check-double', completed: order.status === 'delivered' }
            ];
            
            return timeline.map(item => `
                <div class="d-flex align-items-start mb-3 ${item.completed ? '' : 'opacity-50'}">
                    <div class="me-2">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                            <i class="fas fa-${item.icon} fa-sm"></i>
                        </div>
                    </div>
                    <div>
                        <small class="text-muted">${item.date.toLocaleDateString()}</small><br>
                        <strong>${item.status}</strong>
                    </div>
                </div>
            `).join('');
        }

        function reorderItems(orderId) {
            if (confirm('Do you want to reorder these items?')) {
                // Find the order and add items to cart
                const order = allOrders.find(o => o.orderId === orderId);
                if (order) {
                    order.items.forEach(item => {
                        for (let i = 0; i < item.quantity; i++) {
                            addToCart(Date.now(), item.name, item.price, 'https://via.placeholder.com/200x200/007BFF/ffffff?text=Product');
                        }
                    });
                }
                
                showNotification('Items added to cart!', 'success');
                setTimeout(() => {
                    window.location.href = 'cart.html';
                }, 1500);
            }
        }

        function cancelOrder(orderId) {
            if (confirm('Are you sure you want to cancel this order?')) {
                // Update order status
                const orderIndex = allOrders.findIndex(o => o.orderId === orderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex].status = 'cancelled';
                    localStorage.setItem('aquaStoreOrders', JSON.stringify(allOrders));
                    loadOrders();
                    showNotification('Order cancelled successfully!', 'success');
                }
            }
        }

        function viewOrderDetails(orderId) {
            // For now, just show an alert
            const order = allOrders.find(o => o.orderId === orderId);
            if (order) {
                alert(`Order Details:\n\nOrder ID: ${order.orderId}\nDate: ${order.orderDate}\nStatus: ${order.status}\nTotal: ₹${order.totalAmount}\n\nItems: ${order.items.map(i => `${i.name} x ${i.quantity}`).join(', ')}`);
            }
        }
    </script>
</body>
</html>
